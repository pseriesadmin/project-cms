# CSPM 절대 변형불가 보호 시스템 규칙

## 📋 문서 개요
- **프로젝트**: CrazyShot Project Manager (CSPM)
- **문서 타입**: 절대 변형불가 보호 규칙 (IMMUTABLE PROTECTION RULES)
- **버전**: v1.0.0
- **최종 업데이트**: 2025년 1월
- **중요도**: 🔴 **CRITICAL - 절대 수정 금지**

## 🛡️ 절대 변형불가 보호 시스템

### 14. 다중 사용자 DB정보 동기화 시스템 절대 보호 규칙

#### 14.1 **🔒 핵심 보호 대상 구조**

다음 로직 구조는 **절대 변형 불가**이며, 어떠한 수정 작업 시에도 **완전히 보존**되어야 함:

```typescript
// ✅ 절대 보호 구조 1: 공통 프로젝트 백업 시스템
const payload = dataType === 'project' 
  ? { 
      projectData: data, 
      userId: 'shared_project', // 🔒 절대 변경 금지
      backupType, 
      backupSource 
    }
  : { 
      ...data as any, 
      userId, // 🔒 장비는 개별 사용자 유지
      backupType, 
      backupSource 
    };

// ✅ 절대 보호 구조 2: 공통 복원 시스템
const apiEndpoint = dataType === 'project' 
  ? `/api/project?userId=shared_project${cacheParam}` // 🔒 절대 변경 금지
  : `/api/backup${cacheParam ? `?nocache=${Date.now()}` : ''}`;

// ✅ 절대 보호 구조 3: 동기화 주기
syncInterval = 15000 // 🔒 15초 고정, 절대 변경 금지

// ✅ 절대 보호 구조 4: 페이로드 크기 제한
if (dataSize >= 1000000) { // 🔒 1MB 제한, 절대 변경 금지
  console.warn('페이로드 크기 초과 - 백업 생략');
  return;
}

// ✅ 절대 보호 구조 5: 413 에러 재시도 방지
const is413Error = error instanceof Error && error.message.includes('413');
if (!is413Error && retryCount < maxRetries && backupState.isOnline) {
  // 🔒 413 에러는 재시도하지 않음, 절대 변경 금지
}
```

#### 14.2 **🔒 보호 대상 파일 및 함수**

##### **절대 수정 금지 파일:**
- `src/hooks/useRealtimeBackup.ts` - 백업/복원 핵심 로직
- `src/hooks/useProjectSync.ts` - 동기화 핵심 로직

##### **절대 수정 금지 함수 및 로직:**
1. **`performBackup` 함수의 payload 생성 로직**
2. **`restoreFromCloud` 함수의 API 엔드포인트 로직**
3. **`useProjectSync`의 syncInterval 설정**
4. **페이로드 크기 검증 로직 (1MB 제한)**
5. **413 에러 재시도 방지 로직**

#### 14.3 **🚨 절대 준수 규칙**

##### **규칙 1: 사용자 ID 분리 정책**
```typescript
// ✅ 절대 준수
프로젝트 데이터: userId = 'shared_project' (모든 사용자 공유)
장비 데이터: userId = 개별 사용자 ID (사용자별 격리)

// ❌ 절대 금지
프로젝트 데이터에 개별 사용자 ID 사용
장비 데이터에 공통 사용자 ID 사용
```

##### **규칙 2: 동기화 주기 고정**
```typescript
// ✅ 절대 준수
syncInterval = 15000 // 15초 고정

// ❌ 절대 금지
syncInterval 값 변경 (증가/감소 모두 금지)
동적 syncInterval 설정
```

##### **규칙 3: 페이로드 크기 제한 고정**
```typescript
// ✅ 절대 준수
dataSize >= 1000000 // 1MB 고정 제한

// ❌ 절대 금지
크기 제한 값 변경
크기 제한 로직 우회
```

##### **규칙 4: 413 에러 처리 고정**
```typescript
// ✅ 절대 준수
413 에러 시 재시도 중단 (무한 루프 방지)

// ❌ 절대 금지
413 에러 재시도 로직 추가
413 에러 무시 로직
```

#### 14.4 **⚠️ 변경 시 절대 금지 사항**

1. **공통 프로젝트 백업 ID 변경**
   - `'shared_project'` → 다른 값으로 변경 **절대 금지**

2. **동기화 주기 조정**
   - `15000ms` → 다른 값으로 변경 **절대 금지**

3. **사용자 ID 분리 정책 변경**
   - 프로젝트/장비 데이터 구분 로직 변경 **절대 금지**

4. **페이로드 크기 제한 해제**
   - `1MB` 제한 우회 또는 변경 **절대 금지**

5. **413 에러 재시도 추가**
   - 413 에러 재시도 로직 추가 **절대 금지**

#### 14.5 **🔧 허용되는 수정 범위**

다음 항목들만 수정 가능:

1. **로깅 메시지 개선**
2. **에러 메시지 한글화**
3. **코드 주석 추가/수정**
4. **타입 안전성 개선 (로직 변경 없이)**
5. **성능 최적화 (핵심 로직 변경 없이)**

#### 14.6 **🚨 위반 시 대응 절차**

1. **즉시 롤백**: 보호 규칙 위반 시 즉시 이전 안정 버전으로 롤백
2. **코드 리뷰 강화**: 모든 수정 사항에 대해 보호 규칙 준수 여부 검증
3. **자동 검증**: CI/CD 파이프라인에 보호 규칙 위반 검사 로직 추가

#### 14.7 **📝 변경 승인 프로세스**

보호 대상 코드 수정 시:

1. **사전 승인**: 개발팀 전체 승인 필요
2. **영향도 분석**: 다중 사용자 동기화에 미치는 영향 분석 필수
3. **테스트 강화**: 동기화 시나리오 100% 테스트 커버리지
4. **롤백 계획**: 수정 전 반드시 롤백 계획 수립

## 🎯 **규칙 적용 효과**

### **1. 절대 변형 방지**
- 핵심 동기화 로직 구조 영구 보존
- 다중 사용자 동기화 안정성 보장

### **2. 수정 작업 안전성**
- 다른 기능 추가/수정 시 동기화 시스템 보호
- 의도하지 않은 동기화 로직 변경 방지

### **3. 개발 효율성**
- 동기화 관련 버그 재발 방지
- 안정적인 다중 사용자 환경 보장

---

**⚠️ 경고**: 이 문서의 규칙을 위반하는 모든 코드 수정은 **즉시 롤백** 대상입니다.

**📋 문서 상태**: 절대 변형불가 보호 규칙 - **수정 금지**
